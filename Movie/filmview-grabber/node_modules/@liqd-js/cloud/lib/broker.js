'use strict';

// modify by extending the broker

const { NOOP } = require('./helpers.js');
const { Server } = require('@liqd-js/websocket');
const Client_JSONRPC = require('@liqd-js/client-jsonrpc');

module.exports = class Broker
{
    #server; 
    #nodes = new Set(); 
    #services = new Map();

    constructor( port )
    {
        this.#server = new Server({ port });
        
        this.#server.on( 'client', ( client, req ) =>
        {
            let node = new Client_JSONRPC( client );

            node.on( 'call', async( id, method, params ) => 
            {
                if( method === 'service:call' )
                {
                    let service = params[0], service_node = this.#services.get( service );

                    try
                    {
                        if( !service_node )
                        {
                            service_node = await this._discover( service, node );
                        }

                        node.result( id, await service_node.call( method, ...params ));
                    }
                    catch( err ){ node.error( id, err )}
                }
            });

            this.#nodes.add( node );
        
            client.on( 'close', () => this.#nodes.delete( node ));
            client.on( 'error', NOOP );
        });
    }

    _discover( service, caller )
    {
        return new Promise(( resolve, reject ) =>
        {
            for( let node of this.#nodes )
            {
                if( node === caller ){ continue }

                node.call( 'service:discover', service ).then( has => has ? resolve( node ) : NOOP ).catch( NOOP );
            }
        });
    }
}